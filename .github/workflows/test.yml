name: Continuous Integration

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: write
  packages: write
  attestations: write
  id-token: write

jobs:
  test-composite-actions:
    name: Test Composite Actions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          submodules: recursive
          fetch-depth: 0
          persist-credentials: false

      - name: Setup wash CLI
        uses: ./setup-wash-action
        with:
          wash-version: wash-v2.0.0-rc.7

      # create a test working directory
      - name: Create test directory
        run: |
          mkdir test-dir
          cd test-dir

      - name: Setup cargo-auditable
        uses: ./setup-wash-cargo-auditable
        with:
          working-directory: test-dir

      - name: Create test Rust project
        working-directory: test-dir
        run: |
          cargo init --name test-component

      - name: Test wash-build action
        id: build
        uses: ./wash-build
        with:
          working-directory: test-dir

      - name: Verify build output
        shell: bash
        working-directory: test-dir
        run: |
          echo "Built component at: ${STEPS_BUILD_OUTPUTS_COMPONENT_PATH}"
          if [ ! -f "${STEPS_BUILD_OUTPUTS_COMPONENT_PATH}" ]; then
            echo "Error: Built component not found!"
            exit 1
          fi
        env:
          STEPS_BUILD_OUTPUTS_COMPONENT_PATH: ${{ steps.build.outputs.component_path }}

      - name: Verify wash config updated with cargo-auditable
        shell: bash
        working-directory: test-dir
        run: |
          jq . .wash/config.json
          if ! jq -e '.build.rust.custom_command | arrays | contains(["auditable"])' .wash/config.json; then
            echo "Error: .wash/config.json does not contain 'auditable' in custom_command"
            exit 1
          fi

      - name: Test wash-oci-publish action (multiple tags)
        uses: ./wash-oci-publish
        with:
          component_path: ${{ steps.build.outputs.component_path }}
          registry: ghcr.io
          attestation: "true"
          image_tags: test-${{ github.run_id }}, latest
